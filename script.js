const i18n = {
  ja: {
    brand: "Anime Pilgrimage Japan",
    "nav.tours": "ツアー",
    "nav.why": "選ばれる理由",
    "nav.faq": "FAQ",
    "nav.contact": "お問い合わせ",
    "hero.title": "アニメの世界を旅しよう",
    "hero.subtitle": "聖地で感じる名場面。少人数・多言語ガイドが、移動も手配もまるごとサポート。",
    "hero.ctaPrimary": "ツアーを予約",
    "hero.ctaSecondary": "ルートを見る",
    "hero.meta": "英語・日本語対応／小規模グループ／カスタム手配可",
    "why.title": "選ばれる理由",
    "why.local.title": "アニメ愛 × 旅のプロ",
    "why.local.body": "作品に精通したバイリンガルの有資格ガイドが、聖地の背景やマナーまで丁寧にご案内。",
    "why.seamless.title": "移動も入場もシームレス",
    "why.seamless.body": "交通・チケット・翻訳までお任せ。迷わず効率よく、名場面を存分に巡れます。",
    "why.curated.title": "厳選ルートと季節演出",
    "why.curated.body": "定番から穴場、祭りや桜・紅葉シーズンまで。作品世界を最大化するベストタイミングでご提案。",
    "why.flex.title": "少人数・貸切に柔軟対応",
    "why.flex.body": "1名から参加OK。プライベート手配、食事制限やペース配分なども相談可能です。",
    "why.transparent.title": "明瞭価格・安心サポート",
    "why.transparent.body": "隠れ費用なし。キャンセル規定明確、天候・混雑時の代替案もご用意。",
    "tours.title": "モデルルート",
    "tours.tokyo.title": "東京クラシックス",
    "tours.tokyo.desc": "『君の名は。』や『STEINS;GATE』の舞台、秋葉原・四ツ谷・神田明神などを効率よく。",
    "tours.tokyo.duration": "1日（7–8時間）",
    // Prices now templated via JS
    "tours.kansai.title": "関西トレイル",
    "tours.kansai.desc": "京都『氷菓』、豊郷『けいおん！』旧校舎、奈良の名所を組み合わせて文化も満喫。",
    "tours.kansai.duration": "1–2日",
    "tours.seaside.title": "海辺エスケープ",
    "tours.seaside.desc": "沼津『ラブライブ！サンシャイン!!』や江の島・鎌倉など、海と聖地を一度に。",
    "tours.seaside.duration": "1日",
    "tours.duration.label": "所要",
    "tours.group.label": "人数",
    "tours.group.value": "最大8名",
    "tours.price.label": "料金",
    // Templates
    "price.perPersonFrom": "{price}/人〜",
    "price.perDayFrom": "{price}/日〜",
    "tours.noteTpl": "プライベート/カスタムは別途お見積もり（例：{price}/日〜 {capacity}名まで）。JRパス対応ルート可。",
    "season.title": "ベストシーズン",
    "season.spring.title": "春（3–4月）",
    "season.spring.body": "桜と聖地のコラボ。早朝・夕景で混雑回避の時間設計。",
    "season.summer.title": "夏（7–8月）",
    "season.summer.body": "祭りや花火と合わせた特別行程。熱中症対策も万全に。",
    "season.autumn.title": "秋（10–11月）",
    "season.autumn.body": "紅葉の映えるロケーションへ。撮影スポットを的確にご案内。",
    "quotes.1": "“あのシーンが目の前に。移動もスムーズで安心して楽しめました！” — 米国ゲスト",
    "quotes.2": "“ガイドさんの知識がすごい！ローカルグルメも最高でした” — 台湾ゲスト",
    "faq.title": "よくある質問",
    "faq.lang.q": "対応言語は？",
    "faq.lang.a": "英語・日本語に対応。必要に応じて他言語も手配可能です。",
    "faq.cancel.q": "キャンセル規定は？",
    "faq.cancel.a": "7日前まで無料。以降は規定に基づき一部ご負担いただきます。",
    "faq.fitness.q": "体力に自信がなくても参加できますか？",
    "faq.fitness.a": "無理のないペースで調整します。階段や坂の少ないルートも選べます。",
    "faq.weather.q": "雨天時はどうなりますか？",
    "faq.weather.a": "屋内スポットや代替行程をご提案。安全第一で催行判断します。",
    "faq.payment.q": "支払い方法は？",
    "faq.payment.a": "主要クレジットカード・海外発行カードに対応。事前決済をお願いしています。",
    "booking.title": "予約・お問い合わせ",
    "booking.lead": "ご希望の日程と人数、興味のある作品をお知らせください。24時間以内に回答します。",
    "form.name": "お名前",
    "form.email": "メールアドレス",
    "form.date": "ご希望日",
    "form.group": "人数",
    "form.message": "メッセージ",
    "form.submit": "送信する",
    "contact.whatsapp": "WhatsAppで相談（準備中）",
    "contact.base": "拠点：東京／京都",
    "footer.copy": "© 2025 Anime Pilgrimage Japan",
    "footer.terms": "利用規約",
    "footer.privacy": "プライバシー",
    "footer.imprint": "特定商取引法に基づく表記"
  },
  en: {
    brand: "Anime Pilgrimage Japan",
    "nav.tours": "Tours",
    "nav.why": "Why Us",
    "nav.faq": "FAQ",
    "nav.contact": "Contact",
    "hero.title": "Journey Into Anime — For Real",
    "hero.subtitle": "Step into iconic scenes at real locations. Small groups, bilingual guides, logistics handled end‑to‑end.",
    "hero.ctaPrimary": "Book a Tour",
    "hero.ctaSecondary": "See Routes",
    "hero.meta": "EN/JP guides • Small groups • Custom trips",
    "why.title": "Why Travelers Choose Us",
    "why.local.title": "Otaku Guides, Licensed Pros",
    "why.local.body": "Bilingual licensed guides who truly love anime share context, etiquette, and hidden details.",
    "why.seamless.title": "Seamless Logistics",
    "why.seamless.body": "Transit, tickets, and translation covered so you focus on the magic.",
    "why.curated.title": "Curated & Seasonal",
    "why.curated.body": "From classics to hidden gems, timed for festivals, cherry blossoms, and foliage.",
    "why.flex.title": "Flexible & Private",
    "why.flex.body": "Join solo or as a group. Private custom trips, dietary and pacing options.",
    "why.transparent.title": "Transparent & Safe",
    "why.transparent.body": "No hidden fees. Clear policies and weather/crowd backup plans.",
    "tours.title": "Sample Routes",
    "tours.tokyo.title": "Tokyo Classics",
    "tours.tokyo.desc": "Your Name, Steins;Gate, Akihabara, Yotsuya, Kanda Shrine — all in one efficient day.",
    "tours.tokyo.duration": "1 day (7–8h)",
    "tours.kansai.title": "Kansai Trails",
    "tours.kansai.desc": "Kyoto Hyouka, Toyosato K‑ON! old school, plus Nara highlights and culture.",
    "tours.kansai.duration": "1–2 days",
    "tours.seaside.title": "Seaside Escape",
    "tours.seaside.desc": "Numazu Love Live! Sunshine!! with Enoshima and Kamakura coastal spots.",
    "tours.seaside.duration": "1 day",
    "tours.duration.label": "Duration",
    "tours.group.label": "Group",
    "tours.group.value": "Up to 8",
    "tours.price.label": "Price",
    // Templates
    "price.perPersonFrom": "From {price}/person",
    "price.perDayFrom": "From {price}/day",
    "tours.noteTpl": "Private/custom from {price}/day (up to {capacity}). JR Pass‑friendly routes available.",
    "season.title": "Best Seasons",
    "season.spring.title": "Spring (Mar–Apr)",
    "season.spring.body": "Cherry blossoms and scenes. Early/late slots to avoid crowds.",
    "season.summer.title": "Summer (Jul–Aug)",
    "season.summer.body": "Festivals and fireworks add‑ons with heat‑safety planning.",
    "season.autumn.title": "Autumn (Oct–Nov)",
    "season.autumn.body": "Foliage frames your shots with guide‑picked photo spots.",
    "quotes.1": "“The scene came alive. Logistics were effortless!” — Guest from USA",
    "quotes.2": "“Super knowledgeable guides and amazing local food.” — Guest from Taiwan",
    "faq.title": "FAQ",
    "faq.lang.q": "What languages do you support?",
    "faq.lang.a": "English and Japanese, with other languages on request.",
    "faq.cancel.q": "What is your cancellation policy?",
    "faq.cancel.a": "Free up to 7 days prior; partial fees apply afterward.",
    "faq.fitness.q": "Do I need to be very fit?",
    "faq.fitness.a": "We adjust the pace and can choose routes with fewer stairs or slopes.",
    "faq.weather.q": "What if it rains?",
    "faq.weather.a": "We switch to indoor spots or backup routes, prioritizing safety.",
    "faq.payment.q": "How do I pay?",
    "faq.payment.a": "Major credit cards, including international cards. Advance payment required.",
    "booking.title": "Bookings & Inquiries",
    "booking.lead": "Tell us dates, group size, and favorite titles. We reply within 24 hours.",
    "form.name": "Name",
    "form.email": "Email",
    "form.date": "Preferred Date",
    "form.group": "Group Size",
    "form.message": "Message",
    "form.submit": "Send",
    "contact.whatsapp": "Chat on WhatsApp (coming soon)",
    "contact.base": "Base: Tokyo / Kyoto",
    "footer.copy": "© 2025 Anime Pilgrimage Japan",
    "footer.terms": "Terms",
    "footer.privacy": "Privacy",
    "footer.imprint": "Imprint"
  },
  "zh-TW": {
    brand: "Anime Pilgrimage Japan",
    "nav.tours": "行程",
    "nav.why": "為何選擇我們",
    "nav.faq": "常見問題",
    "nav.contact": "聯絡我們",
    "hero.title": "踏入動畫的現實舞台",
    "hero.subtitle": "小團雙語嚮導，全程代辦交通與門票，安心暢遊聖地。",
    "hero.ctaPrimary": "預約行程",
    "hero.ctaSecondary": "查看路線",
    "hero.meta": "中/英/日 • 小團 • 客製化",
    "why.title": "我們的優勢",
    "why.local.title": "動漫迷＋專業持證嚮導",
    "why.local.body": "熟悉作品背景與禮儀，分享在地故事與拍攝重點。",
    "why.seamless.title": "交通門票一次搞定",
    "why.seamless.body": "專心享受場景重現，其餘交給我們。",
    "why.curated.title": "精選季節搭配",
    "why.curated.body": "從經典到隱藏景點，對應櫻花、祭典、楓紅時節。",
    "why.flex.title": "彈性與包團",
    "why.flex.body": "一人可參加，也可包車客製，飲食與步調皆可調整。",
    "why.transparent.title": "透明與安心",
    "why.transparent.body": "無隱藏費用，清楚規範，備有天候與壅擠備案。",
    "tours.title": "推薦路線",
    "tours.tokyo.title": "東京經典",
    "tours.tokyo.desc": "《你的名字。》、《命運石之門》舞台，秋葉原、四谷、神田明神等。",
    "tours.tokyo.duration": "1天（7–8小時）",
    "tours.kansai.title": "關西路線",
    "tours.kansai.desc": "京都《冰菓》、豐鄉《K-ON!》舊校舍與奈良文化景點。",
    "tours.kansai.duration": "1–2天",
    "tours.seaside.title": "濱海小旅行",
    "tours.seaside.desc": "沼津《Love Live! Sunshine!!》、江之島、鎌倉海岸。",
    "tours.seaside.duration": "1天",
    "tours.duration.label": "時長",
    "tours.group.label": "人數",
    "tours.group.value": "最多8人",
    "tours.price.label": "價格",
    "season.title": "最佳季節",
    "season.spring.title": "春（3–4月）",
    "season.spring.body": "櫻花與名場面。清晨/黃昏避開人潮。",
    "season.summer.title": "夏（7–8月）",
    "season.summer.body": "祭典與花火加購，注意防暑。",
    "season.autumn.title": "秋（10–11月）",
    "season.autumn.body": "楓紅映景，推薦攝影點。",
    "quotes.1": "“場景活了過來，移動安排超順！” — 來自美國",
    "quotes.2": "“嚮導超專業，地方美食也很棒。” — 來自台灣",
    "faq.title": "常見問題",
    "faq.lang.q": "支援語言？",
    "faq.lang.a": "英/日，可另洽其他語言。",
    "faq.cancel.q": "取消規定？",
    "faq.cancel.a": "出發前7天免費，其後依規定收取。",
    "faq.fitness.q": "需要很好的體力嗎？",
    "faq.fitness.a": "會依步調調整，也可選較少階梯的路線。",
    "faq.weather.q": "下雨怎麼辦？",
    "faq.weather.a": "改為室內景點或備用行程，安全優先。",
    "faq.payment.q": "付款方式？",
    "faq.payment.a": "支援主要信用卡，需事前付款。",
    "booking.title": "預約與洽詢",
    "booking.lead": "告訴我們日期、人數與喜歡的作品，24小時內回覆。",
    "form.name": "姓名",
    "form.email": "Email",
    "form.date": "日期",
    "form.group": "人數",
    "form.message": "訊息",
    "form.submit": "送出",
    "contact.whatsapp": "WhatsApp 洽詢（準備中）",
    "contact.base": "據點：東京／京都",
    "footer.copy": "© 2025 Anime Pilgrimage Japan",
    "footer.terms": "條款",
    "footer.privacy": "隱私",
    "footer.imprint": "特商法標示",
    // Templates
    "price.perPersonFrom": "{price}/人起",
    "price.perDayFrom": "{price}/日起",
    "tours.noteTpl": "包團/客製另報（例如：{price}/日起，至多{capacity}人）。可配合JR Pass路線。"
  },
  "zh-CN": {
    brand: "Anime Pilgrimage Japan",
    "nav.tours": "行程",
    "nav.why": "为什么选择我们",
    "nav.faq": "常见问题",
    "nav.contact": "联系",
    "hero.title": "走进动画的真实场景",
    "hero.subtitle": "小团双语向导，交通与门票一并安排，安心省心。",
    "hero.ctaPrimary": "预约行程",
    "hero.ctaSecondary": "查看路线",
    "hero.meta": "中/英/日 • 小团 • 定制",
    "why.title": "我们的优势",
    "why.local.title": "动漫爱好＋持证向导",
    "why.local.body": "熟悉背景与礼仪，分享在地故事与取景要点。",
    "why.seamless.title": "交通门票无缝衔接",
    "why.seamless.body": "专注打卡名场面，其余交给我们。",
    "why.curated.title": "精选季节搭配",
    "why.curated.body": "从经典到隐藏景点，匹配樱花、祭典、红叶季。",
    "why.flex.title": "灵活与包团",
    "why.flex.body": "可单人参加，亦可私团定制，饮食与步调皆可调整。",
    "why.transparent.title": "透明与安心",
    "why.transparent.body": "无隐藏费用，规则清晰，备有天气/拥挤预案。",
    "tours.title": "推荐路线",
    "tours.tokyo.title": "东京经典",
    "tours.tokyo.desc": "《你的名字。》《命运石之门》舞台：秋叶原、四谷、神田明神等。",
    "tours.tokyo.duration": "1天（7–8小时）",
    "tours.kansai.title": "关西路线",
    "tours.kansai.desc": "京都《冰菓》、丰乡《轻音少女》旧校舍与奈良景点。",
    "tours.kansai.duration": "1–2天",
    "tours.seaside.title": "海边小旅行",
    "tours.seaside.desc": "沼津《Love Live! Sunshine!!》、江之岛、镰仓。",
    "tours.seaside.duration": "1天",
    "tours.duration.label": "时长",
    "tours.group.label": "人数",
    "tours.group.value": "最多8人",
    "tours.price.label": "价格",
    "season.title": "最佳季节",
    "season.spring.title": "春（3–4月）",
    "season.spring.body": "樱花与名场面。早晚错峰。",
    "season.summer.title": "夏（7–8月）",
    "season.summer.body": "祭典与烟花追加，注意防暑。",
    "season.autumn.title": "秋（10–11月）",
    "season.autumn.body": "红叶入景，推荐拍摄点。",
    "quotes.1": "“名场面重现，行程安排顺畅！” — 来自美国",
    "quotes.2": "“向导很专业，当地美食很棒。” — 来自台湾",
    "faq.title": "常见问题",
    "faq.lang.q": "支持语言？",
    "faq.lang.a": "英/日，可另约其他语言。",
    "faq.cancel.q": "取消政策？",
    "faq.cancel.a": "出发前7天免费，此后按规定收取。",
    "faq.fitness.q": "需要很好的体力吗？",
    "faq.fitness.a": "会调整节奏，也可选台阶较少路线。",
    "faq.weather.q": "下雨怎么办？",
    "faq.weather.a": "改为室内或备用路线，安全优先。",
    "faq.payment.q": "支付方式？",
    "faq.payment.a": "支持主要信用卡，需预付。",
    "booking.title": "预约与咨询",
    "booking.lead": "告知日期、人数和喜欢的作品，24小时内回复。",
    "form.name": "姓名",
    "form.email": "邮箱",
    "form.date": "日期",
    "form.group": "人数",
    "form.message": "留言",
    "form.submit": "发送",
    "contact.whatsapp": "WhatsApp 咨询（准备中）",
    "contact.base": "据点：东京／京都",
    "footer.copy": "© 2025 Anime Pilgrimage Japan",
    "footer.terms": "条款",
    "footer.privacy": "隐私",
    "footer.imprint": "特商法标示",
    "price.perPersonFrom": "{price}/人起",
    "price.perDayFrom": "{price}/日起",
    "tours.noteTpl": "包团/定制另议（示例：{price}/日起，至多{capacity}人）。可配合JR Pass路线。"
  },
  ko: {
    brand: "Anime Pilgrimage Japan",
    "nav.tours": "투어",
    "nav.why": "선택 이유",
    "nav.faq": "FAQ",
    "nav.contact": "문의",
    "hero.title": "애니 성지로 떠나는 여행",
    "hero.subtitle": "소그룹 이중언어 가이드, 교통·입장까지 원스톱 지원.",
    "hero.ctaPrimary": "투어 예약",
    "hero.ctaSecondary": "루트 보기",
    "hero.meta": "영/일 가이드 • 소그룹 • 맞춤",
    "why.title": "왜 우리인가",
    "why.local.title": "애니 사랑 + 전문 가이드",
    "why.local.body": "작품 배경과 에티켓까지 꼼꼼히 안내.",
    "why.seamless.title": "이동·입장도 매끄럽게",
    "why.seamless.body": "교통·티켓·통역까지 맡겨 주세요.",
    "why.curated.title": "정선 루트와 계절 연출",
    "why.curated.body": "정석부터 히든 스팟, 벚꽃/단풍/축제 타이밍.",
    "why.flex.title": "유연한 소규모·대절",
    "why.flex.body": "1인 참여 가능, 프라이빗 맞춤/식단/페이스 조정.",
    "why.transparent.title": "명확한 가격·안심 지원",
    "why.transparent.body": "숨은 비용 없음, 기상·혼잡 대안 제공.",
    "tours.title": "모델 루트",
    "tours.tokyo.title": "도쿄 클래식",
    "tours.tokyo.desc": "너의 이름은, 슈타게 무대 아키하바라·요츠야·칸다묘진.",
    "tours.tokyo.duration": "1일 (7–8시간)",
    "tours.kansai.title": "간사이 트레일",
    "tours.kansai.desc": "교토 빙과, 토요사토 케이온! 구교사, 나라 문화.",
    "tours.kansai.duration": "1–2일",
    "tours.seaside.title": "바다 여행",
    "tours.seaside.desc": "누마즈 러브라이브 선샤인!!, 에노시마·가마쿠라.",
    "tours.seaside.duration": "1일",
    "tours.duration.label": "소요",
    "tours.group.label": "인원",
    "tours.group.value": "최대 8명",
    "tours.price.label": "요금",
    "season.title": "베스트 시즌",
    "season.spring.title": "봄 (3–4월)",
    "season.spring.body": "벚꽃과 명장면, 혼잡 피한 시간대.",
    "season.summer.title": "여름 (7–8월)",
    "season.summer.body": "축제·불꽃놀이 옵션, 더위 대비.",
    "season.autumn.title": "가을 (10–11월)",
    "season.autumn.body": "단풍 명소와 촬영 포인트.",
    "quotes.1": "“장면이 눈앞에! 이동도 매끄러웠어요.” — 미국 게스트",
    "quotes.2": "“가이드 지식이 대단! 로컬 음식도 최고.” — 대만 게스트",
    "faq.title": "자주 묻는 질문",
    "faq.lang.q": "지원 언어?",
    "faq.lang.a": "영어/일본어, 기타 언어 요청 가능.",
    "faq.cancel.q": "취소 규정?",
    "faq.cancel.a": "출발 7일 전까지 무료, 이후 일부 수수료.",
    "faq.fitness.q": "체력이 약해도 가능한가요?",
    "faq.fitness.a": "페이스 조정 및 계단 적은 루트 가능.",
    "faq.weather.q": "비가 오면?",
    "faq.weather.a": "실내/대체 루트 제안, 안전 우선.",
    "faq.payment.q": "결제 방법?",
    "faq.payment.a": "주요 신용카드, 사전 결제.",
    "booking.title": "예약/문의",
    "booking.lead": "일정·인원·선호 작품을 알려 주세요. 24시간 내 회신.",
    "form.name": "이름",
    "form.email": "이메일",
    "form.date": "희망일",
    "form.group": "인원",
    "form.message": "메시지",
    "form.submit": "보내기",
    "contact.whatsapp": "WhatsApp 상담(준비 중)",
    "contact.base": "거점: 도쿄/교토",
    "footer.copy": "© 2025 Anime Pilgrimage Japan",
    "footer.terms": "약관",
    "footer.privacy": "개인정보",
    "footer.imprint": "표시",
    "price.perPersonFrom": "{price}/인 부터",
    "price.perDayFrom": "{price}/일 부터",
    "tours.noteTpl": "프라이빗/맞춤 별도 견적(예: {price}/일 부터, 최대 {capacity}명). JR Pass 루트 가능."
  }
};

const currencyByLang = (lang, navLang = navigator.language || 'en-US') => {
  const map = {
    ja: 'JPY', 'zh-TW': 'TWD', 'zh-CN': 'CNY', ko: 'KRW',
    'en-GB': 'GBP', 'en-AU': 'AUD', 'en-CA': 'CAD', 'en-US': 'USD',
    fr: 'EUR', es: 'EUR', de: 'EUR'
  };
  if (map[lang]) return map[lang];
  // If generic 'en', infer from navigator
  if (lang === 'en') {
    const region = navLang.split('-')[1] || 'US';
    return map[`en-${region}`] || 'USD';
  }
  return 'JPY';
};

function applyI18n(lang) {
  const dict = i18n[lang] || i18n.ja;
  document.documentElement.lang = lang;
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) el.textContent = dict[key];
  });
  const select = document.getElementById('lang-select');
  if (select && select.value !== lang) select.value = lang;
  const title = lang === 'en' ? 'Anime Pilgrimage Japan | Anime Tours in Japan' : 'Anime Pilgrimage Japan | アニメ聖地巡礼ツアー';
  const desc = lang === 'en' ? 'Small-group, bilingual guides for real-world anime locations across Japan.' : '外国人観光客向けの少人数・多言語ガイドによる日本アニメ聖地巡礼ツアー。';
  document.title = title;
  const metaDesc = document.querySelector('meta[name="description"]');
  if (metaDesc) metaDesc.setAttribute('content', desc);
  // Apply price localization
  localizePrices(lang);
}

// Currency rates
async function fetchRatesJPY() {
  try {
    const cache = localStorage.getItem('apj-rates');
    if (cache) {
      const { ts, data } = JSON.parse(cache);
      if (Date.now() - ts < 12 * 60 * 60 * 1000) return data;
    }
    const res = await fetch('https://api.exchangerate.host/latest?base=JPY');
    const json = await res.json();
    if (json && json.rates) {
      localStorage.setItem('apj-rates', JSON.stringify({ ts: Date.now(), data: json.rates }));
      return json.rates;
    }
    throw new Error('No rates');
  } catch (e) {
    // Fallback rough rates
    return { USD: 0.0067, EUR: 0.0061, GBP: 0.0052, AUD: 0.010, CAD: 0.0091, TWD: 0.21, CNY: 0.048, KRW: 9.1, JPY: 1 };
  }
}

function formatCurrency(amount, currency, lang) {
  try {
    return new Intl.NumberFormat(lang.replace('_', '-'), { style: 'currency', currency, maximumFractionDigits: 0 }).format(amount);
  } catch {
    return `${currency} ${Math.round(amount).toLocaleString()}`;
  }
}

async function localizePrices(lang) {
  const currency = currencyByLang(lang);
  const rates = await fetchRatesJPY();
  const rate = rates[currency] || 1; // JPY fallback
  document.querySelectorAll('.price[data-jpy]').forEach(el => {
    const jpy = parseFloat(el.getAttribute('data-jpy')) || 0;
    const tplKey = el.getAttribute('data-i18n-tpl') || 'price.perPersonFrom';
    const dict = i18n[lang] || i18n.en;
    const price = currency === 'JPY' ? formatCurrency(jpy, 'JPY', lang) : formatCurrency(jpy * rate, currency, lang);
    const tpl = dict[tplKey] || i18n.en[tplKey] || '{price}';
    el.textContent = tpl.replace('{price}', price);
  });
  document.querySelectorAll('.price-note[data-jpy]').forEach(el => {
    const jpy = parseFloat(el.getAttribute('data-jpy')) || 0;
    const cap = el.getAttribute('data-capacity') || '6';
    const dict = i18n[lang] || i18n.en;
    const price = currency === 'JPY' ? formatCurrency(jpy, 'JPY', lang) : formatCurrency(jpy * rate, currency, lang);
    const tpl = dict['tours.noteTpl'] || i18n.en['tours.noteTpl'];
    el.textContent = tpl.replace('{price}', price).replace('{capacity}', cap);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('apj-lang') || (navigator.language.startsWith('en') ? 'en' : 'ja');
  applyI18n(saved);
  const select = document.getElementById('lang-select');
  if (select) {
    select.addEventListener('change', () => {
      const lang = select.value;
      localStorage.setItem('apj-lang', lang);
      applyI18n(lang);
    });
  }
  document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.addEventListener('click', e => {
      const id = a.getAttribute('href');
      if (id.length > 1) {
        e.preventDefault();
        document.querySelector(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });

  // Mobile menu toggle
  const nav = document.getElementById('primary-nav');
  const menuBtn = document.querySelector('.menu-toggle');
  if (menuBtn && nav) {
    const closeMenu = () => {
      nav.classList.remove('open');
      menuBtn.setAttribute('aria-expanded', 'false');
      menuBtn.textContent = '☰';
    };
    const openMenu = () => {
      nav.classList.add('open');
      menuBtn.setAttribute('aria-expanded', 'true');
      menuBtn.textContent = '✕';
    };
    menuBtn.addEventListener('click', () => {
      if (nav.classList.contains('open')) closeMenu(); else openMenu();
    });
    // Close menu when clicking a link
    nav.querySelectorAll('a').forEach(link => link.addEventListener('click', closeMenu));
    // Close on resize to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth > 980) closeMenu();
    });
  }

  // Booking form AJAX submission (Formspree-compatible)
  const FORM_ENDPOINT = 'https://formspree.io/f/your-id'; // TODO: replace with your Formspree form ID
  const form = document.getElementById('booking-form');
  const statusEl = document.getElementById('form-status');
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = saved === 'en' ? 'Sending…' : '送信中…';
      const formData = new FormData(form);
      const name = formData.get('name');
      const email = formData.get('email');
      if (!name || !email) {
        statusEl.textContent = saved === 'en' ? 'Name and Email are required.' : 'お名前とメールは必須です。';
        return;
      }
      try {
        const res = await fetch(FORM_ENDPOINT, {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          body: formData
        });
        if (res.ok) {
          form.reset();
          statusEl.textContent = saved === 'en' ? 'Thank you! We will reply within 24 hours.' : '送信ありがとうございます。24時間以内にご返信します。';
        } else {
          const data = await res.json().catch(() => ({}));
          const msg = data.errors?.map(e => e.message).join(', ');
          throw new Error(msg || 'Request failed');
        }
      } catch (err) {
        console.error(err);
        const subject = encodeURIComponent('[Tour Inquiry] Anime Pilgrimage Japan');
        const bodyLines = [
          `Name: ${formData.get('name') || ''}`,
          `Email: ${formData.get('email') || ''}`,
          `Date: ${formData.get('date') || ''}`,
          `People: ${formData.get('people') || ''}`,
          `Message: ${formData.get('message') || ''}`
        ];
        const body = encodeURIComponent(bodyLines.join('\n'));
        window.location.href = `mailto:hello@example.com?subject=${subject}&body=${body}`;
        statusEl.textContent = saved === 'en' ? 'Couldn’t reach server. Opened mail app as fallback.' : 'サーバに接続できませんでした。メールアプリを開きました。';
      }
    });
  }
});
